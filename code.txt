DAD Worksheet 6 Code



---

composer update

php artisan migrate:fresh --seed

php artisan storage:link


---

npm install --save-dev eslint @eslint/js globals nodemon

---

npx eslint --init

---

import { serverStart } from "./server.js"

const PORT = process.env.PORT || 3000

serverStart(PORT)

console.log(`Socket.io server running on port ${PORT}`)
console.log("Waiting for connections...")




---


const users = new Map()

export const addUser = (socket, user) => {
  	users.set(socket.id, user)
}

export const removeUser = (socketID) => {
	const userToDelete = { ... users.get(socketID)} 
	users.delete(socketID)
	return userToDelete
}

export const getUser = (socketID) => {
  return users.get(socketID)
}

export const getUserByID = (userID) => {
  for (let [socketID, user] of users.entries()) {
    if (user.id == userID) {
      return {
        user,
        socketID,
      }
    }
  }
  return null
}

export const getUserCount = () => {
  return users.size
}




---


import { addUser, removeUser, getUserCount } from "../state/connection.js"

export const handleConnectionEvents = (io, socket) => {
	socket.on("join", (user) => {
		addUser(socket, user)
		
		console.log(`[Connection] User ${user.name} has joined the server`)
		console.log(`[Connection] ${getUserCount()} users online`)
		
		io.emit("player-joined", {
			socketID: socket.id,
			userID: user.id,
			userName: user.name,
		})
	})
	
	socket.on("leave", () => {
		const user = removeUser(socket.id)
		console.log(`[Connection] User ${user.name} has left the server`)
		console.log(`[Connection] ${getUserCount()} users online`)
	})
	
	socket.on("disconnect", () => {
		console.log("Connection Lost:", socket.id)
		const user = removeUser(socket.id)
		console.log(`[Connection] ${getUserCount()} users online`)
	})  	
}


---



import { defineStore } from 'pinia'
import { inject, ref } from 'vue'
import { useAuthStore } from './auth'

export const useSocketStore = defineStore('socket', () => {
    const socket = inject('socket')
    const authStore = useAuthStore()

    const joined = ref(false)

    const emitJoin = (user) => {
        if (joined.value) return
        console.log(`[Socket] Joining Server`)
        socket.emit('join', user)
        joined.value = true
    }

    const emitLeave = () => {
        socket.emit('leave')
        console.log(`[Socket] Leaving Server`)
        joined.value = false
    }

    const handleConnection = () => {
      socket.on('connect', () => {
          console.log(`[Socket] Connected -- ${socket.id}`)
          if (authStore.isLoggedIn && !joined.value) {
                emitJoin(authStore.currentUser)
            }
        })

        socket.on('disconnect', () => {
            joined.value = false
            console.log(`[Socket] Disconnected -- ${socket.id}`)
        })
    }

    return {
      emitJoin,
      emitLeave,
      handleConnection,
    }
})


---


import MultiplayerLobbyPage from '@/pages/game/MultiplayerLobbyPage.vue'
import MultiplayerGamePage from '@/pages/game/MultiplayerGamePage.vue'
import { useAuthStore } from '@/stores/auth'
import { toast } from 'vue-sonner'

// New Routes-  CHILDREN OF path: '/games',
{
    path: 'lobby',
    name: 'multiplayer-lobby',
    component: MultiplayerLobbyPage,
    meta: { requiresAuth: true },
},
{
    path: 'multiplayer',
    name: 'multiplayer',
    component: MultiplayerGamePage,
    meta: { requiresAuth: true },
},


// Route Guards
router.beforeEach((to, from, next) => {
    const authStore = useAuthStore()
    if (to.meta.requiresAuth && !authStore.isLoggedIn) {
        toast.error('This navigation requires authentication')
        next({ name: 'login' })
    } else {
        next()
    }
})



---

import { useGameStore } from './game'
// ....
const gameStore = useGameStore()
// ....

const emitGetGames = () => {
    socket.emit('get-games')
}

const handleGameEvents = () => {
    socket.on('games', (games) => {
        console.log(`[Socket] server emited games | game count ${games.length}`)
        gameStore.setGames(games) // Import and instantiate the game store
    })
}




---

import { toast } from 'vue-sonner'
// ...
const socket = inject('socket') 

const games = ref([])

const createGame = (difficulty = 'medium') => {
	if (!authStore.currentUser) {
		toast.error('You must be logged in to create a game')
		return
	}
	if (!socket || !socket.connected) {
		toast.error('Not connected to server. Please refresh the page.')
		return
	}
	socket.emit('create-game', difficulty)
}

const setGames = (newGames) => {
	games.value = newGames
	console.log(`[Game] Games changed | game count ${games.value.length}`)
}

const myGames = computed(() => {
	return games.value.filter((game) => game.creator == authStore.currentUser.id)
})

const availableGames = computed(() => {
	return games.value.filter((game) => game.creator != authStore.currentUser.id)
})


---


import { getUser } from "../state/connection.js"
import { createGame, getGames } from "../state/game.js"

export const handleGameEvents = (io, socket) => {
    socket.on("create-game", (difficulty) => {
        const user = getUser(socket.id)
        const game = createGame(difficulty, user)
        socket.join(`game-${game.id}`)
        console.log(`[Game] ${user.name} created a new game - ID: ${game.id}`)
        io.emit("games", getGames())
    })
  
    socket.on("get-games", () => {
        io.emit("games", getGames())
    })
}

---


const games = new Map()
let currentGameID = 0

export const createGame = (difficulty, user) => {
    currentGameID++
    const game = {
        id: currentGameID,
        difficulty,
        creator: user.id,
        player1: user.id,
        player2: null,
    }
    games.set(currentGameID, game)
    return game
}

export const getGames = () => {
    return games.values().toArray()
}

---


const currentUserID = computed(() => {
	return currentUser.value?.id
})


---


const emitJoinGame = (game) => {
	console.log(`[Socket] Joining Game ${game.id}`)
	socket.emit('join-game', game.id, authStore.currentUser.id)
}

  
const emitFlipCard = (gameID, card) => {
	socket.emit('flip-card', gameID, card)
}


---


socket.on('game-change', (game) => {
	gameStore.setMultiplayerGame(game)
})


---

import { useRouter } from 'vue-router'

const router = useRouter()
// ...



const joinGame = (game) => {
	socketStore.emitJoinGame(game)
}

const startGame = (game) => {
	gameStore.multiplayerGame = game
	router.push({ name: 'multiplayer' })
}


---


const multiplayerGame = ref({})

const setMultiplayerGame = (game) => {
	multiplayerGame.value = game
	console.log(`[Game] Multiplayer Game changed | game moves ${game.moves}`)
}


---

import { createGame, getGames, joinGame, flipCard, clearFlippedCard} from "../state/game.js"


socket.on("join-game", (gameID, userID) => {
	joinGame(gameID, userID)
	socket.join(`game-${gameID}`)
	console.log(`[Game] User ${userID} joined game ${gameID}`)
	io.emit("games", getGames())
	io.to(`game-${gameID}`).emit("game-ready")
})

socket.on("flip-card", (gameID, card) => {
	const game = flipCard(gameID, card)
	io.to(`game-${gameID}`).emit("game-change", game)
})


---

let currentGameID = 0
const options = [1, 2, 3, 4, 5, 6, 7, 8].map((i) => {
	return { face: i, matched: false, flipped: false }
})

const generateBoard = (difficulty) => {
	const cards = []
	let numPairs = 4

	if (difficulty === "medium") numPairs = 6
	if (difficulty === "hard") numPairs = 8

	const boardOptions = options.slice(0, numPairs)
	let idCounter = 0

	boardOptions.forEach((option) => {
		cards.push({ id: idCounter++, ...option })
		cards.push({ id: idCounter++, ...option })
	})

	for (let i = cards.length - 1; i > 0; i--) {
		const j = Math.floor(Math.random() * (i + 1));
		[cards[i], cards[j]] = [cards[j], cards[i]]
	}

	return cards
}


---


export const createGame = (difficulty, user) => {

	currentGameID++
	const game = {
		id: currentGameID,
		difficulty,
		creator: user.id,
		player1: user.id,
		player2: null,
		winner: null,
		currentPlayer: user.id,
		cards: generateBoard(difficulty),
		flippedCards: [],
		matchedPairs: [],
		started: false,
		complete: false,
		moves: 0,
		beganAt: null,
		endedAt: null,
	}

	games.set(currentGameID, game)
	return game
}


---



export const joinGame = (gameID, player2) => {
    games.get(gameID).player2 = player2
}


---

export const flipCard = (gameID, card) => {
	const game = games.get(gameID)
	
	if (!game.beganAt) {
		game.beganAt = new Date()
		game.started = true
	}

	const gameCard = game.cards.find((c) => c.id == card.id)
	if (game.flippedCards.includes(gameCard.id)) return
	if (game.matchedPairs.includes(gameCard.id)) return
	if (game.flippedCards.length >= 2) return

	game.flippedCards.push(gameCard.id)
	gameCard.flipped = true
	if (game.flippedCards.length == 2) {
		game.moves++
		checkForMatch(game)
		checkForGameComplete(game)
	}

	return game
}

const checkForMatch = (game) => {

	if (game.flippedCards.length !== 2) return

	const [first, second] = game.flippedCards
	const firstCard = game.cards.find((c) => c.id === first)
	const secondCard = game.cards.find((c) => c.id === second)

	if (firstCard.face === secondCard.face) {
		game.matchedPairs.push(first, second)
		firstCard.matched = true
		secondCard.matched = true
		game.flippedCards = []
	} else {
		firstCard.flipped = true
		secondCard.flipped = true
		setTimeout(() => {
			triggerFlipDelay(game)
		}, 1000)
	}
}

const checkForGameComplete = (game) => {

	if (game.matchedPairs.length === game.cards.length) {
		game.complete = true
		game.winner = game.currentPlayer
		game.endedAt = new Date()
	}
}


export const clearFlippedCard = (game) => {

	if (game.flippedCards.length !== 2) return

	const [first, second] = game.flippedCards
	const firstCard = game.cards.find((c) => c.id === first)
	const secondCard = game.cards.find((c) => c.id === second)
	
	firstCard.flipped = false
	secondCard.flipped = false
	game.flippedCards = []
	game.currentPlayer = game.currentPlayer == game.player1 ? game.player2 : game.player1
	
	return game
}


---


import { server } from "../server.js"

export const triggerFlipDelay = (game) => {
	game = clearFlippedCard(game)
	server.io.to(`game-${game.id}`).emit("game-change", game)
}


---

import { triggerFlipDelay } from "../events/game.js"


